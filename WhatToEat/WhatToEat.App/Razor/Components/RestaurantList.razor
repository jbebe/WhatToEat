@using WhatToEat.App.Common;
@using WhatToEat.App.Razor.Internal;
@using WhatToEat.App.Services;
@using WhatToEat.App.Storage.Dtos;
@using WhatToEat.App.Storage.Model;
@using WhatToEat.App.Storage.Repositories;
@inherits BaseComponent;

<MudText Typo="Typo.h5" Class="mb-4">Restaurants</MudText>

<MudTable Items="@Restaurants" Dense Hover Breakpoint="Breakpoint.Sm" Loading="@Loading" LoadingProgressColor="Color.Info"
		  @ref="TableRef" T="Restaurant" MultiSelection SelectOnRowClick="false"
		  SelectedItemsChanged="SelectedItemsChanged">
	<HeaderContent>
		<MudTh>Name</MudTh>
		<MudTh>Payment method</MudTh>
	</HeaderContent>
	<RowTemplate>
		<MudTd DataLabel="Name">@context.Name</MudTd>
		<MudTd DataLabel="PaymentMethod">
			<PaymentMethodList Value="@context.PaymentMethods" />
		</MudTd>
	</RowTemplate>
</MudTable>

@code {
	[Inject]
	RestaurantRepository RestaurantRepository { get; set; } = default!;

	[Inject]
	VoteService VoteService { get; set; } = default!;

	[Inject]
	SessionService SessionService { get; set; } = default!;

	HashSet<Restaurant> SelectedItems = default!;

	IEnumerable<Restaurant> Restaurants => RestaurantMap.Values.OrderBy(x => x.Name);

	Dictionary<Id<Restaurant>, Restaurant> RestaurantMap { get; set; } = new();

	bool Loading { get; set; } = true;

	MudTable<Restaurant> TableRef = default!;

	List<Restaurant> Votes = default!;

	protected override async Task OnInitializedAsync()
	{
		await SessionService.LoginAsync(CancellationToken);
		RestaurantMap = (await RestaurantRepository.GetAllAsync(CancellationToken)).ToDictionary(x => x.Id);
		Votes = await VoteService.GetVoteAsync(CancellationToken);
		SelectedItems = Votes.Select(x => RestaurantMap[x.Id]).ToHashSet();
	}

	protected override void OnAfterRender(bool firstRender)
	{
		Loading = false;
		base.OnAfterRender(firstRender);
	}

	void SelectedItemsChanged(HashSet<Restaurant> selectedItems)
	{
		// Blazor waits for this method if awaited, even though we call it like a regular function
#pragma warning disable CS4014
		VoteService.CastVoteAsync(selectedItems.ToList(), CancellationToken);
#pragma warning restore CS4014
	}
}
