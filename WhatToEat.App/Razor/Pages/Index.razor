@page "/"
@using WhatToEat.App.Services
@using WhatToEat.App.Services.Models
@using WhatToEat.App.Storage.Model
@using WhatToEat.App.Storage.Repositories
@inherits BaseComponent

<PageTitle>What To Eat</PageTitle>

@if (SessionService.IsLoggedIn)
{
	<MudGrid Class="top-section">
		<MudItem xs="12" sm="6" md="6">
			<RestaurantList />
		</MudItem>
		<MudItem xs="12" sm="6" md="6">
			<VoteResult />
			<PresenceList />
			<Statistics />
		</MudItem>
	</MudGrid>
} 

<LoginModal />

@code {
	[Inject]
	NavigationManager NavigationManager { get; set; } = default!;

	[Inject]
	LocalEventService LocalEventService { get; set; } = default!;

	[Inject]
	VoteService VoteService { get; set; } = default!;

	[Inject]
	SessionService SessionService { get; set; } = default!;

	[Inject]
	RestaurantService RestaurantService { get; set; } = default!;
	
	[Inject]
	PresenceService PresenceService { get; set; } = default!;

	protected override void OnInitialized()
	{
		LocalEventService.OnMessage -= OnMessage;
		LocalEventService.OnMessage += OnMessage;
	}

	Task OnMessage(BroadcastMessage message)
	{
		if (message.Type == BroadcastEventType.LoggedIn)
		{
			InvokeAsync(StateHasChanged);
		}
		return Task.CompletedTask;
	}

	public new void Dispose()
	{
		LocalEventService.OnMessage -= OnMessage;
		base.Dispose();
	}
}