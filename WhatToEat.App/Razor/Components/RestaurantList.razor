@using WhatToEat.App.Common
@using WhatToEat.App.Razor.Internal
@using WhatToEat.App.Services
@using WhatToEat.App.Storage.Dtos
@using WhatToEat.App.Storage.Model
@using WhatToEat.App.Storage.Repositories
@implements IDisposable

<MudText Typo="Typo.h5" Class="mb-4">Restaurants</MudText>

<MudTable Items="@RestaurantService.Restaurants.Values" Dense Hover Breakpoint="Breakpoint.Sm" Loading="@Loading" LoadingProgressColor="Color.Info"
		  @ref="TableRef" T="Restaurant" MultiSelection SelectOnRowClick="false"
		  SelectedItemsChanged="SelectedItemsChanged" SelectedItems="SelectedItems">
	<HeaderContent>
		<MudTh>Name</MudTh>
		<MudTh>Payment method</MudTh>
	</HeaderContent>
	<RowTemplate>
		<MudTd DataLabel="Name">@context.Name</MudTd>
		<MudTd DataLabel="PaymentMethod">
			<PaymentMethodList Value="@context.PaymentMethods" />
		</MudTd>
	</RowTemplate>
</MudTable>

@code {
	[Inject]
	RestaurantService RestaurantService { get; set; } = default!;

	[Inject]
	VoteService VoteService { get; set; } = default!;

	bool Loading { get; set; } = true;

	MudTable<Restaurant>? TableRef;

	HashSet<Restaurant> SelectedItems { get; set; } = default!;

	protected override void OnInitialized()
	{
		RestaurantService.OnChanged -= UpdateRestaurantsAsync;
		RestaurantService.OnChanged += UpdateRestaurantsAsync;

		//RestaurantService.
	}

	private Task UpdateRestaurantsAsync()
	{
		SelectedItems = new HashSet<Restaurant>(VoteService.Vote?.Restaurants.ToHashSet() ?? new());
		InvokeAsync(StateHasChanged);
		return Task.CompletedTask;
	}

	//#pragma warning disable BL0005
	//			TableRef!.SelectedItems = SelectedItems;
	//#pragma warning restore BL0005

	protected override void OnAfterRender(bool firstRender)
	{
		Loading = false;
		if (firstRender) InvokeAsync(StateHasChanged);
		base.OnAfterRender(firstRender);
	}

	void SelectedItemsChanged(HashSet<Restaurant> selectedItems)
	{
		if (Loading) return;

#pragma warning disable CS4014
		VoteService.CastVoteAsync(selectedItems.ToList(), CancellationToken.None);
#pragma warning restore CS4014
	}

	public void Dispose()
	{
		RestaurantService.OnChanged -= UpdateRestaurantsAsync;
	}
}
